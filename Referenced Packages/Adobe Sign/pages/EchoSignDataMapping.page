<apex:page >
<!-- <apex:page standardController="SIGN_Data_Mapping__c" extensions="EchoSignDataMapping_Controller" title="EchoSign Data Mapping: {!proTemplate.Name}" sidebar="{!IF(NOT ISNULL($CurrentPage.parameters.showheadersidebar),$CurrentPage.parameters.showheadersidebar,'true')}" showHeader="{!IF(NOT ISNULL($CurrentPage.parameters.showheadersidebar),$CurrentPage.parameters.showheadersidebar,'true')}">
	<apex:includeScript value="{!URLFOR($Resource.jquery, '/js/jquery-1.4.4.min.js')}" />

    <apex:styleSheet value="{!URLFOR($Resource.yuiskin)}" />
 
    <apex:includeScript value="{!URLFOR($Resource.yui290, '/yui/build/yahoo-dom-event/yahoo-dom-event.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.yui290, '/yui/build/container/container-min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.yui290, '/yui/build/animation/animation-min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.yui290, '/yui/build/dragdrop/dragdrop-min.js')}" />
    
    <style type="text/css">
    
        #previewPanel .bd {
            overflow:auto;
        }
    </style>
    
<style>
     .container1{
         overflow:auto;
     }        
</style>

	<apex:outputpanel id="mappingPanel" style="display: none;">
	
     <apex:form id="ProcessTemplateId">
        
        <apex:sectionHeader title="EchoSign Data Mapping" subtitle="{!mappingName}"/>
        
        <apex:pagemessages id="themessages"/>  
        
        <apex:pageBlock title="EchoSign Data Mapping Editor"  helpTitle="EchoSign Help and Support" helpUrl="{!$Page.EchosignHelp}" id="actionPageBlock">

            <apex:pageBlockButtons location="top">
                <apex:commandbutton action="{!save}" value="Save"/>
                <apex:commandbutton action="{!cancel}" value="Cancel" onclick="if(!confirm('Are you sure?')){return false;}" />
                <apex:commandbutton action="{!delete}" value="Delete" onclick="if(!confirm('Are you sure?')){return false;}" />                          
            </apex:pageBlockButtons> 
                       
                <apex:pageBlockSection title="Mapping Information" collapsible="false" columns="1">
                    <apex:outputpanel >Set up EchoSign Data Mappings to specify how to update Salesforce.com object fields with data entered by signers into EchoSign document form fields. 
                    The data is pushed back into Salesforce automatically after the EchoSign agreement is signed. Please refer to the <a style="color: blue;" href="http://www.adobe.com/go/echosign_salesforce_installguide_v13" target="pdf">installation and customization guide</a> for additional instructions.</apex:outputPanel>
                </apex:pageBlockSection>
                <apex:pageBlockSection collapsible="false" columns="2">
                	<apex:pageBlockSectionItem labelStyle="text-align: left; padding-left: 10px; width: 13%;" dataStyle="width: 5%;">
                		<apex:outputLabel value="EchoSign Data Mapping Name" for="mappingNameField"/>
                		<apex:inputfield value="{!proTemplate.Name}" required="true" id="mappingNameField" />
                	</apex:pageBlockSectionItem>
                	<apex:pageBlockSectionItem labelStyle="width: 8%;">
                		<apex:outputLabel value="Default Data Mapping?" for="mappingDefaultField"/>
                		<apex:inputfield value="{!proTemplate.Default_Data_Mapping__c}" id="mappingDefaultField"/>
                	</apex:pageBlockSectionItem>
                </apex:pageBlockSection>  
                <apex:pageBlockSection id="s0" title="Import EchoSign Document Form Fields (optional)" collapsible="true" columns="1">
            		<script>twistSection(document.getElementById("{!$Component.ProcessTemplateId.actionPageBlock.s0}").childNodes[0].childNodes[0]); </script>
            		<apex:pageBlockSectionItem >
                        To map data from EchoSign document fields into Salesforce, you need to first import the available form fields from existing EchoSign agreements that have been sent and signed.  You can import fields from multiple agreements.
                    </apex:pageBlockSectionItem>                        
                    <apex:pageBlockSectionItem >
                        <apex:outputPanel >
                            <table width="100%">                            
                                <tr>
                                    <td align="left" style="width: 400px;">
                                        <apex:outputpanel id="totalImportFormFieldNamesPanel"><font color="red">{!totalImportedFormFieldNames}</font> form fields were imported to this mapping.</apex:outputPanel>
                                    </td>
                                    <td align="left" style="width: 300px;">
                                        <b><apex:outputlabel value="Import fields from"/></b>&nbsp;
                                        <apex:inputfield value="{!newAgreementEvent.Agreement__c}">
                                            <apex:actionSupport event="onchange"
                                                action="{!onAgreementLookupChange}"
                                                rerender="formButton,themessages"/>
                                        </apex:inputfield>
                                    </td>
                                    <td align="left" style="margin-left: 0px; padding-left: 0px; border-left: 0px;">
                                        <apex:commandbutton action="{!retrieveFormData}" value="Import Form Fields" oncomplete="buildSecurityPopup('{!cusSettingsPrivate.API_Key__c}')" status="FormLoadingStatus" id="formButton" disabled="{!isRetrieveFormDataButtonDisabled}" rerender="themessages,totalImportFormFieldNamesPanel,pb2"/>
                                    </td>
                                </tr>
                                <tr>
                                	<td>
                                		<apex:actionStatus id="FormLoadingStatus">
                    						<apex:facet name="start">
                        						<div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;" />
                        						<img src="{!$Resource.loading}" style="width:20px;height:20px" />
                        					</apex:facet>
                    					</apex:actionStatus>
                                	</td>
                                </tr>
                            </table>
                        </apex:outputPanel>
                     </apex:pageBlockSectionItem>                                                                                           
                </apex:pageBlockSection>                     
        </apex:pageBlock>
<script>
		YAHOO.namespace("echosign.com");
        
        YAHOO.echosign.com.showMe = function() {
            document.getElementById("settingsPanel").style.display = "block";
            
            YAHOO.echosign.com.myDialog.show();
            YAHOO.echosign.com.myDialog.center();
        }

        YAHOO.echosign.com.hideMe = function() {
            YAHOO.echosign.com.myDialog.hide();
        }

        // Function called when the DOM is ready to create the dialog,
        // render the dialog into the document body, add our dialog skin
        // css to the body tag, and wire up the buttons on our dialog    
        YAHOO.echosign.com.init = function() {
			if( !{!isApiKeySet} ) {
				window.location = '/apex/EchoSignSetupWizard?showheadersidebar=true';
			} else {
				document.getElementById('{!$Component.mappingPanel}').style.display = 'block';
			}
            
            document.body.className = document.body.className + " yui-skin-sam";
        
            YAHOO.echosign.com.myDialog = new YAHOO.widget.Panel(
                "settingsPanel",  // The id of our dialog container
                { 
                    width           :   200,    // You can play with this until it's right
                    visible         :   false,  // Should be invisible when rendered
                    draggable       :   true,   // Make the dialog draggable
                    close           :   true,  // Don't include a close title button
                    modal           :   true,   // Make it modal
                    fixedCenter     :   false,   // Keep centered if window is scrolled
                    zindex          :   100,     // Make sure it's on top of everything
                    underlay        :   "none",
                    
                    // This line adds the appear/vanish fade effect
                    effect          :   {
                                          effect:YAHOO.widget.ContainerEffect.FADE,
                                          duration:0.00
                                        } 
                }
            );
        
            YAHOO.echosign.com.myDialog.render(document.body);
        }
    
        YAHOO.util.Event.addListener(window, "load", YAHOO.echosign.com.init);
		
            // Calculate the size of the page so we can set the popup size
             var viewportwidth;
             var viewportheight;
             
             // the more standards compliant browsers (mozilla/netscape/opera/IE7) use window.innerWidth and window.innerHeight
             
             if (typeof window.innerWidth != 'undefined')
             {
                  viewportwidth = window.innerWidth,
                  viewportheight = window.innerHeight
             }
             
            // IE6 in standards compliant mode (i.e. with a valid doctype as the first line in the document)
            
             else if (typeof document.documentElement != 'undefined'
                 && typeof document.documentElement.clientWidth !=
                 'undefined' && document.documentElement.clientWidth != 0)
             {
                   viewportwidth = document.documentElement.clientWidth,
                   viewportheight = document.documentElement.clientHeight
             }
             
             // older versions of IE
             
             else
             {
                   viewportwidth = document.getElementsByTagName('body')[0].clientWidth,
                   viewportheight = document.getElementsByTagName('body')[0].clientHeight
             }
            var frameHeight = viewportheight*.90; 
            var frameWidth = viewportwidth*.80;
            // document.getElementById('{!$Component.ProcessTemplateId.actionPageBlock.pbs1.theFrame}').style.width = frameWidth + 'px';
            
            function buildSecurityPopup(apiKey) {
       			if( apiKey ) {
       				return;
       			}
            	
	       		var secbox = sfdcPage.getDialogById("EchoSignSecurityPopup");
	        	                
	        	if( secbox == null ) {
	               secbox = new parent.SimpleDialog("EchoSignSecurityPopup", true); 
	               secbox.cancel=function() { secbox.hide(); };
	               parent.secbox = secbox; 
	               sfdcPage.dialogs[parent.secbox.id] = parent.secbox;
	               secbox.displayX=false;                   
	               secbox.createDialog();        
	               secbox.setWidth("435px");                       
	         	}
	         	
	         	var frameUrl = '{!$Page.ApiKeyInput}';
	         	var srcFrame = '<iframe height="480px" width="400px" frameborder="no" id="popup" style="border:0;" src="'+frameUrl+'"></iframe>';
	           	secbox.setContentInnerHTML(srcFrame);
	            secbox.show();
            } 
</script>       
        <apex:pageBlock id="pb2" mode="edit">                   
                <apex:pageBlockSection collapsible="false" columns="1">     
                    <apex:pageBlockSectionItem >
                        <b>Data Mapping Items</b>   
                    </apex:pageBlockSectionItem>                                                                      
                </apex:pageBlockSection>    
                    <apex:repeat value="{!lstAgreeProcessOps}" var="rec" id="lstAgreeProcessOpsTable">        
                        <apex:pageBlockSection id="strAgreeObjectNameSection" title="Map Data to the EchoSign {!rec.displayLabel} Object" columns="1">
                            <apex:outputPanel id="strAgreeObjectNameSectionList" >
                                    <apex:pageBlockTable id="strAgreeObjectNametable" value="{!rec.lstProcessMap}" var="p" columns="6">              
                                      <apex:column width="25%">
                                      <apex:facet name="header"><apex:outputpanel title="Select the type of data which will be pushed into the Salesforce field after the agreement is signed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Type__c.label}</apex:outputpanel></apex:facet>
                                            <apex:inputfield id="agreementFieldMappingType" value="{!p.proMap.Type__c}" required="true">
                                                <apex:actionSupport event="onchange" action="{!onMappingTypeChange}" rerender="agreementFieldMappingSource,agreementFieldMappingName,agreementFieldMappingOverwrite,strAgreeObjectNameSectionList,themessages">
                                                    <apex:param value="{!p.row}" name="row" assignTo="{!row}" />  
                                                </apex:actionSupport>
                                            </apex:inputfield>             
                                      </apex:column>  
                                      <apex:column style="padding-right: 0px; margin-right: 0px; padding-left: 5px;">
                                      	<apex:outputpanel id="agreementFieldMappingSelector" rendered="{! p.proMap.Type__c = 'EchoSign Form Field' }">
                                      		<apex:image title="Switch to list of imported field names" value="{!$Resource.ListFormFieldName}" rendered="{! p.proMap.Input_Type__c <> 'List' }">
                                       			<apex:actionSupport event="onclick" action="{!toggleAgreementFormFieldNameSelector}" rerender="agreementFieldMappingSource,agreementFieldMappingSelector,themessages">
                                            		<apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param> 
                                           		</apex:actionSupport>
                                        	</apex:image>
                                      		<apex:image title="Switch to input text for field name" value="{!$Resource.TextFormFieldName}" rendered="{! p.proMap.Input_Type__c <> 'Text' }">
                                       			<apex:actionSupport event="onclick" action="{!toggleAgreementFormFieldNameSelector}" rerender="agreementFieldMappingSource,agreementFieldMappingSelector,themessages">
                                            		<apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param> 
                                            	</apex:actionSupport>
                                     		</apex:image>
                                     	</apex:outputpanel>
                                      </apex:column>  
                                      <apex:column width="25%">
                                       <apex:facet name="header"><apex:outputpanel title="Specify an EchoSign document field, Salesforce Agreement object field, or a constant value that will be the source of the data which will be pushed into Salesforce after the agreement is signed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Source__c.label}</apex:outputpanel></apex:facet>
                                          <apex:outputpanel id="agreementFieldMappingSource">
                                              <apex:outputpanel rendered="{!p.proMap.Type__c='Agreement Field'}">
                                                  <apex:selectList id="agreementRelationshipFields" value="{!p.proMap.Source__c}" size="1"> 
                                                      <apex:selectOptions value="{!lstAgreementFields}"/>   
                                                  </apex:selectList>
                                              </apex:outputpanel>   
                                              <apex:outputpanel rendered="{!p.proMap.Type__c='Constant'}">                                                               
                                                <apex:inputfield value="{!p.proMap.Source__c}" style="width: 300px;">
                                                	<apex:actionSupport event="onchange" rerender="agreementFieldMappingType,agreementFieldMappingOverwrite,themessages"/>
                                                </apex:inputfield>
                                              </apex:outputpanel>                
                                              <apex:outputpanel rendered="{! p.proMap.Type__c = 'EchoSign Form Field' }">
                                                  <apex:selectList id="mergeFields" value="{!p.proMap.Source__c}" size="1" rendered="{! p.proMap.Input_Type__c = 'List' }"> 
                                                      <apex:selectOptions value="{!lstFormDataFields}"/>
                                                      <apex:actionSupport event="onchange" rerender="agreementFieldMappingType,agreementFieldMappingOverwrite,themessages"/> 
                                                  </apex:selectList>
                                                  <apex:inputfield value="{!p.proMap.Source__c}" style="width: 200px;" rendered="{! p.proMap.Input_Type__c = 'Text' }"/>
                                              </apex:outputpanel>   
                                          </apex:outputpanel>
                                      </apex:column>                  
                                      <apex:column width="30%"> 
                                       <apex:facet name="header"><apex:outputpanel title="Select a target Salesforce field from the EchoSign Agreement object where the data entered by signers will be populated after the agreement is signed.">Target Salesforce Field - Agreement Object</apex:outputpanel></apex:facet>
                                          <apex:outputpanel id="agreementFieldMappingName">
                                              <apex:selectList id="lstFields" value="{!p.proMap.Name}" size="1"> 
                                                  <apex:selectOptions value="{!rec.lstFields}"/>
                                                  <apex:actionSupport event="onchange" rerender="agreementFieldMappingType,agreementFieldMappingOverwrite,agreementFieldMappingOverwrite,themessages"/> 
                                              </apex:selectList>
                                          </apex:outputpanel>                                      
                                      </apex:column>
                                      <apex:column >
                                       <apex:facet name="header"><apex:outputpanel title="Disable a mapping row if you do not want it to run at the time this mapping is executed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Disable__c.label}</apex:outputpanel></apex:facet>
                                        <apex:inputfield id="agreementFieldMappingDisable" value="{!p.proMap.Disable__c}">
                                        	<apex:actionSupport event="onchange" rerender="agreementFieldMappingType,agreementFieldMappingSource,agreementFieldMappingName,themessages"/>
                                        </apex:inputfield>                
                                      </apex:column>    
                                      <apex:column width="20%"> 
                                        <apex:actionRegion >
                                            <apex:commandButton action="{!delMapping}" title="Delete Field Mapping" alt="Delete Field Mapping" image="{!$Resource.ActionDelete}" rerender="strAgreeObjectNameSectionList,themessages" status="DeletingStatus" style="background:transparent;border-width:0px;">        
                                                <apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                                <apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param>                                            
                                            </apex:commandButton>
                                            <apex:commandButton action="{!assignFieldMapping}" title="Field Mapping Settings" alt="Field Mapping Settings" image="{!$Resource.GearSettings}" oncomplete="YAHOO.echosign.com.showMe();" rerender="settingsForm" style="background:transparent;border-width:0px;">
                                            	<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                                <apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param>                                            
                                            </apex:commandButton>
                                            <apex:actionStatus id="DeletingStatus">
                                                <apex:facet name="start">
                                                <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                                <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                            </apex:actionStatus>
                                        </apex:actionRegion>                
                                      </apex:column>                              
        
                                    </apex:pageBlockTable>
                            </apex:outputPanel>
                            <apex:outputPanel id="ButtonSection">
                                <apex:commandLink action="{!addMapping}" value="Add Mapping" rerender="strAgreeObjectNameSectionList,themessages" status="LoadingStatus">
                                    <apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                </apex:commandLink> &nbsp; &nbsp; &nbsp;
                                <apex:actionStatus id="LoadingStatus">
                                    <apex:facet name="start">
                                    <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                    <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                </apex:actionStatus>
                            </apex:outputPanel>
                        </apex:pageBlockSection>
                    </apex:repeat>   
                    <apex:repeat value="{!lstProcessOps}" var="rec" id="lstProcessOpsTable">        
                        <apex:pageBlockSection id="strObjectNameSection" title="Map Data to the {!rec.displayLabel} Object" columns="1">
                            <apex:outputPanel id="strObjectNameListSection">
                            		<apex:outputPanel >
                                    <br/>
                                    <h1>Map EchoSign Form Field Data to Target Salesforce Field</h1>
                            		<br/>
                            		<br/>
                            		</apex:outputPanel>
                                    <apex:pageBlockTable id="strObjectNametable" value="{!rec.lstProcessMap}" var="p" columns="6">              
                                      <apex:column width="25%">
                                       <apex:facet name="header"><apex:outputpanel title="Select the type of data which will be pushed into the Salesforce field after the agreement is signed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Type__c.label}</apex:outputpanel></apex:facet>
                                            <apex:inputfield id="objectFieldMappingType" value="{!p.proMap.Type__c}" required="true">
                                                <apex:actionSupport event="onchange" action="{!onMappingTypeChange}" rerender="objectFieldMappingSource,objectFieldMappingName,objectFieldMappingOverwrite,strObjectNameListSection,themessages">
                                                    <apex:param value="{!p.row}" name="row" assignTo="{!row}" />  
                                                </apex:actionSupport> 
                                            </apex:inputfield>             
                                      </apex:column>
                                      <apex:column style="padding-right: 0px; margin-right: 0px; padding-left: 5px;">
                                      	<apex:outputpanel id="objectFieldMappingSelector"  rendered="{! p.proMap.Type__c = 'EchoSign Form Field' }">
                                      		<apex:image title="Switch to list of imported field names" value="{!$Resource.ListFormFieldName}" rendered="{! p.proMap.Input_Type__c <> 'List' }">
                                       			<apex:actionSupport event="onclick" action="{!toggleObjectFormFieldNameSelector}" rerender="objectFieldMappingSource,objectFieldMappingSelector,themessages">
                                            		<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                            		<apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param> 
                                           		</apex:actionSupport>
                                        	</apex:image>
                                      		<apex:image title="Switch to input text for field name" value="{!$Resource.TextFormFieldName}" rendered="{! p.proMap.Input_Type__c <> 'Text' }">
                                       			<apex:actionSupport event="onclick" action="{!toggleObjectFormFieldNameSelector}" rerender="objectFieldMappingSource,objectFieldMappingSelector,themessages">
                                            		<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                            		<apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param> 
                                            	</apex:actionSupport>
                                     		</apex:image>
                                     	</apex:outputpanel>
                                      </apex:column> 
                                      <apex:column width="25%">
                                       <apex:facet name="header"><apex:outputpanel title="Specify an EchoSign document field, Salesforce Agreement object field, or a constant value that will be the source of the data which will be pushed into Salesforce after the agreement is signed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Source__c.label}</apex:outputpanel></apex:facet>
                                          <apex:outputpanel id="objectFieldMappingSource">
                                              <apex:outputpanel rendered="{!p.proMap.Type__c='Agreement Field'}">
                                                  <apex:selectList id="agreementRelationshipFields" value="{!p.proMap.Source__c}" size="1"> 
                                                      <apex:selectOptions value="{!lstAgreementFields}"/>   
                                                  </apex:selectList>
                                              </apex:outputpanel>   
                                              <apex:outputpanel rendered="{!p.proMap.Type__c='Constant'}">                                                               
                                                <apex:inputfield value="{!p.proMap.Source__c}" style="width: 300px;">
                                                	<apex:actionSupport event="onchange" rerender="objectFieldMappingType,objectFieldMappingOverwrite,themessages"/>
                                                </apex:inputfield>
                                              </apex:outputpanel>                
                                              <apex:outputpanel rendered="{! p.proMap.Type__c = 'EchoSign Form Field' }">
                                                  <apex:selectList id="mergeFields" value="{!p.proMap.Source__c}" size="1" rendered="{! p.proMap.Input_Type__c = 'List' }"> 
                                                      <apex:selectOptions value="{!lstFormDataFields}"/>
                                                      <apex:actionSupport event="onchange" rerender="agreementFieldMappingType,agreementFieldMappingOverwrite,themessages"/> 
                                                  </apex:selectList>
                                                  <apex:inputfield value="{!p.proMap.Source__c}" style="width: 200px;" rendered="{! p.proMap.Input_Type__c = 'Text' }"/>
                                              </apex:outputpanel>   
                                          </apex:outputpanel>
                                      </apex:column>                        
                                      <apex:column width="30%"> 
                                       <apex:facet name="header"><apex:outputpanel title="Select a target Salesforce field from the EchoSign Agreement object where the data entered by signers will be populated after the agreement is signed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Name.label}</apex:outputpanel></apex:facet>
                                          <apex:outputpanel id="objectFieldMappingName">
                                              <apex:selectList id="lstFields" value="{!p.proMap.Name}" size="1"> 
                                                  <apex:selectOptions value="{!rec.lstFields}"/>    
                                                  <apex:actionSupport event="onchange" rerender="objectFieldMappingType,objectFieldMappingOverwrite,themessages"/> 
                                              </apex:selectList>
                                          </apex:outputpanel>               
                                      </apex:column>
                                      <apex:column >
                                      	<apex:facet name="header"><apex:outputpanel title="Disable a mapping row if you do not want it to run at the time this mapping is executed.">{!$ObjectType.SIGN_Field_Mapping__c.fields.Disable__c.label}</apex:outputpanel></apex:facet>
                                        <apex:inputfield id="objectFieldMappingDisable" value="{!p.proMap.Disable__c}">
                                        	<apex:actionSupport event="onchange" rerender="objectFieldMappingType,objectFieldMappingSource,objectFieldMappingName,themessages"/>
                                        </apex:inputfield>                
                                      </apex:column>   
                                      <apex:column width="20%"> 
                                        <apex:actionRegion >
                                            <apex:commandButton action="{!delMapping}" title="Delete Field Mapping" alt="Delete Field Mapping" image="{!$Resource.ActionDelete}" rerender="strObjectNameListSection,themessages" status="DeletingStatus" style="background:transparent;border-width:0px;">
                                            	<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                                <apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param>                                            
                                            </apex:commandButton>
                                            <apex:commandButton action="{!assignFieldMapping}" title="Field Mapping Settings" alt="Field Mapping Settings" image="{!$Resource.GearSettings}" oncomplete="YAHOO.echosign.com.showMe();" rerender="settingsForm" style="background:transparent;border-width:0px;">
                                            	<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                                <apex:param value="{!p.row}" name="row" assignTo="{!row}"></apex:param>                                            
                                            </apex:commandButton>
                                            <apex:actionStatus id="DeletingStatus">
                                                <apex:facet name="start">
                                                <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                                <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                            </apex:actionStatus>
                                        </apex:actionRegion>                
                                      </apex:column>                              
        
                                    </apex:pageBlockTable>
                            </apex:outputPanel>
                            <apex:outputPanel id="ButtonSection">
                                <apex:commandLink action="{!addMapping}" value="Add Field Mapping" rerender="strObjectNameListSection,themessages" status="LoadingStatus">
                                    <apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                </apex:commandLink> &nbsp; &nbsp; &nbsp;
                                <apex:actionStatus id="LoadingStatus">
                                    <apex:facet name="start">
                                    <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                    <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                </apex:actionStatus>                             
                            </apex:outputPanel>
                            
                            
                            <apex:outputPanel id="strFileObjectNameListSection">
                            	<apex:outputPanel >
                            	<br/>
                            	<h1>Map EchoSign Signed Agreement, Audit Trail, or Supporting Documents to Target Salesforce Object</h1>
                            	<br/>
                            	<br/>
                            	</apex:outputPanel>
                            	<apex:pageBlockTable id="strFileObjectNametable" value="{!rec.fileMappingWrappers}" var="fileMappingWrapper" columns="5">              
                                	<apex:column width="30%">
                                    	<apex:facet name="header"><apex:outputpanel title="Select the type of data which will be pushed into the Salesforce field after the agreement is signed.">{!$ObjectType.SIGN_File_Mapping__c.fields.Source_Type__c.label}</apex:outputpanel></apex:facet>
                                     	<apex:inputfield id="objectFileMappingSourceType" value="{!fileMappingWrapper.fileMapping.Source_Type__c}" required="true">
                                     		<apex:actionSupport event="onchange" action="{!onFileMappingSourceTypeChange}" rerender="objectFileMappingTargetType,strFileObjectNameListSection,objectFileMappingTargetFieldName,themessages">
                                           		<apex:param value="{!fileMappingWrapper.row}" name="row" assignTo="{!row}" />
                                           		<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>  
                                        	</apex:actionSupport>
                                     	</apex:inputfield>             
                                  	</apex:column>  
                                    <apex:column width="30%">
                                    	<apex:facet name="header"><apex:outputpanel title="Specify whether to attach the EchoSign file to the object or include a link to the file.">{!$ObjectType.SIGN_File_Mapping__c.fields.Target_Type__c.label}</apex:outputpanel></apex:facet>
                                      	<apex:selectList id="objectFileMappingTargetType" value="{!fileMappingWrapper.fileMapping.Target_Type__c}" size="1" required="true"> 
                                        	<apex:selectOptions value="{!fileMappingWrapper.targetTypeFields}"/>    
                                            <apex:actionSupport event="onchange" action="{!onFileMappingTypeChange}" rerender="strFileObjectNameListSection,objectFileMappingTargetFieldName,themessages">
                                           		<apex:param value="{!fileMappingWrapper.row}" name="row" assignTo="{!row}" />  
                                        	</apex:actionSupport>  
                                        </apex:selectList>
                                  	</apex:column>                     
                                  	<apex:column width="30%"> 
                                    	<apex:facet name="header"><apex:outputpanel title="Select a target Salesforce field where the data entered by signers will be pushed into after the agreement is signed.">{!$ObjectType.SIGN_File_Mapping__c.fields.Target_Field_Name__c.label}</apex:outputpanel></apex:facet>
                                      	<apex:outputpanel id="objectFileMappingTargetFieldName" rendered="{! fileMappingWrapper.fileMapping.Target_Type__c = 'Add a reference link to the file' }">
                                        	<apex:selectList id="objectFileFieldNames" value="{!fileMappingWrapper.fileMapping.Target_Field_Name__c}" size="1"> 
                                            	<apex:selectOptions value="{!rec.textFields}"/>
                                            </apex:selectList>
                                      	</apex:outputpanel>               
                                  	</apex:column>
                                  	<apex:column >
                                    	<apex:facet name="header">{!$ObjectType.SIGN_File_Mapping__c.fields.Disable__c.label}</apex:facet>
                                        <apex:inputfield id="objectFileMappingDisable" value="{!fileMappingWrapper.fileMapping.Disable__c}" />                
                                  	</apex:column>   
                                   	<apex:column > 
                                    	<apex:actionRegion >
                                        	<apex:commandButton action="{!delFileMapping}" title="Delete File Mapping" alt="Delete File Mapping" image="{!$Resource.ActionDelete}" rerender="strFileObjectNameListSection,themessages" status="FileDeletingStatus" style="background:transparent;border-width:0px;">
                                            	<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                                <apex:param value="{!fileMappingWrapper.row}" name="row" assignTo="{!row}"></apex:param>                                            
                                            </apex:commandButton>
                                            <apex:commandButton action="{!assignFileMapping}" title="File Mapping Settings" alt="File Mapping Settings" image="{!$Resource.GearSettings}" oncomplete="YAHOO.echosign.com.showMe();" rerender="settingsForm" style="background:transparent;border-width:0px;">
                                            	<apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                                <apex:param value="{!fileMappingWrapper.row}" name="row" assignTo="{!row}"></apex:param>                                              
                                            </apex:commandButton>
                                            <apex:actionStatus id="FileDeletingStatus">
                                                <apex:facet name="start">
                                                <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                                <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                            </apex:actionStatus>
                                        </apex:actionRegion>                
                                 	</apex:column>                              
								</apex:pageBlockTable>
                            </apex:outputPanel>
                            <apex:outputPanel id="FileButtonSection">
                            	<apex:commandLink action="{!addFileMapping}" value="Add File Mapping" rerender="strFileObjectNameListSection,themessages" status="FileLoadingStatus">
                                    <apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                </apex:commandLink> &nbsp; &nbsp; &nbsp;
                                <apex:actionStatus id="FileLoadingStatus">
                                    <apex:facet name="start">
                                    <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                    <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                </apex:actionStatus>                                   
                                <apex:outputPanel >
                               		<br/>
                               		<br/>
                               		<br/>             
                                    <apex:commandButton action="{!delProcessOperation}" value="Delete Object" rerender="pb2,themessages" status="LoadingStatus">
                                                <apex:param value="{!rec.strObjectName}" name="strObjectName" assignTo="{!strObjectName}"></apex:param>
                                    </apex:commandButton>
                                </apex:outputPanel>                         
                            </apex:outputPanel>
                            
                            
                        </apex:pageBlockSection>
                    </apex:repeat>                           
        </apex:pageBlock> 

        <apex:pageBlock id="theObjectNavigation" mode="edit">    
                                     
                <apex:pageBlockSection id="relatedObjectsSection" title="Map Data to Additional Related Objects" collapsible="false" columns="1">
                	<apex:outputpanel >To map EchoSign document field data into a related Salesforce object, first select the related object and then specify the source and target values.</apex:outputpanel>
                    <apex:commandlink id="addRelatedObjectsButton" status="AddLoadingStatus" action="{!showRelatedObjectsSection}" rendered="{!isAddRelatedObjectsButtonRendered}" rerender="relatedObjectsSection,,themessages">Select a related object</apex:commandlink> 
                    <apex:actionStatus id="AddLoadingStatus">
                    	<apex:facet name="start">
                        	<div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;" />
                        	<img src="{!$Resource.loading}" style="width:20px;height:20px" />
                    	</apex:facet>
                    </apex:actionStatus>
                    <apex:outputPanel id="relatedObjectsSectionLabel" rendered="{!isShowRelatedObjectsSectionRendered}"><b>Select the Salesforce object you want to map data to:</b></apex:outputPanel>
                    <apex:outputPanel id="relatedObjectsSectionContent" rendered="{!isShowRelatedObjectsSectionRendered}">
                        <table width="100">                         
                            <tr>
                                <td align="left" width="100px" style="padding-top: 5px;">                                                                
                                    <b>Agreement: &nbsp;</b>
                                </td>    
                                <apex:actionregion >                            
                                <apex:repeat value="{!lstObjectNavigation}" var="rec" id="lstObjectNavigation">        
                                    <td align="left" width="100px" style="vertical-align: middle; padding-bottom: 10px;">                                       
                                      <apex:selectList style="" id="agreementRelationshipFields" value="{!rec.fieldName}" size="1" disabled="{!rec.disabled}"> 
                                            <apex:selectOptions value="{!rec.lstFields}"/>
                                            <apex:actionSupport event="onchange" action="{!addObjectNavigation}" rerender="theObjectNavigation,themessages,addObjectButton,backObjectButton" status="AddingStatus"/> 
                                      </apex:selectList>
                                    </td>
                                    <td align="left" width="5px" style="padding-top: 5px;">                                                                
                                        <b>&nbsp;: &nbsp;</b>
                                    </td>  
                                </apex:repeat>  
                                    
                                    <td align="left" width="5px">                                                            
                                    	<apex:commandButton id="backObjectButton" 
                                    		image="{!$Resource.MappingBackButton}" 
                                    		action="{!delObjectNavigation}" 
                                    		value="Save" 
                                    		rerender="theObjectNavigation,themessages,addObjectButton,agreementRelationshipFields" 
                                    		rendered="{!isBackObjectButtonRendered}"
                                    		title="Back"
                                    		style="padding-top: 2px; width: 20px; height: 20px; background: transparent; border-width: 0px;;"/>
                                    </td>
                                    <td>
                                        <apex:actionStatus id="AddingStatus">
                                            <apex:facet name="start">
                                            <div class="waitingSearchDiv" style="width: 100%; height: 100%; display: ; opacity:.5;"></div>
                                            <img src="{!$Resource.loading}" style="width:20px;height:20px" /></apex:facet>
                                        </apex:actionStatus>
                                    </td>                                   
                                </apex:actionregion>                                                                                                                                        
                            </tr>
                            <tr>
                                <td align="left" width="5px">                                                                
                                    <apex:commandbutton id="addObjectButton" action="{!addProcessOperation}" value="Add Object" disabled="{!isAddObjectButtonDisabled}"/>
                                </td>
                            </tr>
                        </table>
                    </apex:outputPanel>                      
                </apex:pageBlockSection>                
        </apex:pageBlock>
        
        <apex:pageBlock id="bottomButtons">    
            <apex:pageBlockButtons location="top">
                <apex:commandbutton action="{!save}" value="Save"/>
                <apex:commandbutton action="{!cancel}" value="Cancel" onclick="if(!confirm('Are you sure?')){return false;}" />
                <apex:commandbutton action="{!delete}" value="Delete" onclick="if(!confirm('Are you sure?')){return false;}" />                          
            </apex:pageBlockButtons>  
        </apex:pageBlock>
            
        <apex:outputtext rendered="false" value="{!proTemplate.Merge_Field_CSV__c}"/>
	</apex:form>
	
	</apex:outputpanel>
	
	<div id="settingsPanel" style="display: none; width:500px;">
        <apex:form id="settingsForm">	
            <apex:pageBlock id="settingsBlock" mode="detail" rendered="{!isFieldMapping}">
            	<apex:pageBlockSection title="Field Mapping Value Settings" columns="2" collapsible="false">
            		<apex:outputLabel style="font-weight: bold;" value="{!$ObjectType.SIGN_Field_Mapping__c.fields.Do_No_Overwrite_Existing__c.label}" for="objectFieldMappingOverwrite" title="If a value already exists in the target Salesforce field, do not overwrite the value using this mapping rule."/>
                    <apex:inputCheckbox id="objectFieldMappingOverwrite" title="If a value already exists in the target Salesforce field, do not overwrite the value using this mapping rule.">
                    	<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="{!$ObjectType.SIGN_Field_Mapping__c.fields.Do_Not_Write_Empty__c.label}" for="objectFieldMappingWriteEmpty" title="If the source value from the EchoSign agreement is empty, do not write the empty value into the target Salesforce field using this mapping rule."/>
                   	<apex:inputCheckbox id="objectFieldMappingWriteEmpty" title="If the source value from the EchoSign agreement is empty, do not write the empty value into the target Salesforce field using this mapping rule.">
                   		<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
                </apex:pageBlockSection>
            	<apex:pageBlockSection title="Field Mapping Status Settings" columns="2" collapsible="false">
            		<apex:outputLabel style="font-weight: bold;" value="Signed Status" for="objectFieldMappingSigned"/>
            		<apex:inputCheckbox id="objectFieldMappingSigned" value="{!selectedMappingEntryWrapper.isSignedEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Approved Status" for="objectFieldMappingApproved"/>
            		<apex:inputCheckbox id="objectFieldMappingApproved" value="{!selectedMappingEntryWrapper.isApprovedEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Out for Signature Status" for="objectFieldMappingOutSignature"/>
            		<apex:inputCheckbox id="objectFieldMappingOutSignature" value="{!selectedMappingEntryWrapper.isOutSignatureEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Out for Approval Status" for="objectFieldMappingOutApproval"/>
            		<apex:inputCheckbox id="objectFieldMappingOutApproval" value="{!selectedMappingEntryWrapper.isOutApprovalEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Cancelled / Declined Status" for="objectFieldMappingCancelledDeclined"/>
            		<apex:inputCheckbox id="objectFieldMappingCancelledDeclined" value="{!selectedMappingEntryWrapper.isCancelledDeclinedEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Waiting for Counter-Signature Status" for="objectFieldMappingCounterSignature"/>
            		<apex:inputCheckbox id="objectFieldMappingCounterSignature" value="{!selectedMappingEntryWrapper.isCounterSignatureEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Waiting for Counter-Approval Status" for="objectFieldMappingCounterApproval"/>
            		<apex:inputCheckbox id="objectFieldMappingCounterApproval" value="{!selectedMappingEntryWrapper.isCounterApprovalEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            	</apex:pageBlockSection>
            </apex:pageBlock>
            <apex:pageBlock id="settingsFileBlock" mode="detail" rendered="{!isFileMapping}">
            	<apex:pageBlockSection title="File Mapping Status Settings" columns="2" collapsible="false">
            		<apex:outputLabel style="font-weight: bold;" value="Signed Status" for="objectFieldMappingSigned"/>
            		<apex:inputCheckbox id="objectFieldMappingSigned" value="{!selectedFileMappingEntryWrapper.isSignedEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Approved Status" for="objectFieldMappingApproved"/>
            		<apex:inputCheckbox id="objectFieldMappingApproved" value="{!selectedFileMappingEntryWrapper.isApprovedEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Out for Signature Status" for="objectFieldMappingOutSignature"/>
            		<apex:inputCheckbox id="objectFieldMappingOutSignature" value="{!selectedFileMappingEntryWrapper.isOutSignatureEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Out for Approval Status" for="objectFieldMappingOutApproval"/>
            		<apex:inputCheckbox id="objectFieldMappingOutApproval" value="{!selectedFileMappingEntryWrapper.isOutApprovalEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Cancelled / Declined Status" for="objectFieldMappingCancelledDeclined"/>
            		<apex:inputCheckbox id="objectFieldMappingCancelledDeclined" value="{!selectedFileMappingEntryWrapper.isCancelledDeclinedEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Waiting for Counter-Signature Status" for="objectFieldMappingCounterSignature"/>
            		<apex:inputCheckbox id="objectFieldMappingCounterSignature" value="{!selectedFileMappingEntryWrapper.isCounterSignatureEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            		
            		<apex:outputLabel style="font-weight: bold;" value="Waiting for Counter-Approval Status" for="objectFieldMappingCounterApproval"/>
            		<apex:inputCheckbox id="objectFieldMappingCounterApproval" value="{!selectedFileMappingEntryWrapper.isCounterApprovalEvent}">
            			<apex:actionSupport event="onchange" rerender="settingsForm"/>
            		</apex:inputCheckbox>
            	</apex:pageBlockSection>
            </apex:pageBlock>
        </apex:form>
    </div> -->
                           
</apex:page>